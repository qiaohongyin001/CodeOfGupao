## 基于MongoDB实现网络云盘实战

### 一 目的

- 为什么要使用MongoDB实现云盘？
  - GridFS在Java中应用，缓存中间件，结构化的非关系型数据库
- 云盘因何而存在？
  - 来自tom老师的原来项目，经过了改造，完全去Servlet化的框架（Spring Boot）
- 个人经验分享
  - tom老师分享经验，相当于全公司所有项目中用到文件存储依赖

百度云盘、腾讯微盘、360网盘、阿里OSS、七牛云 ...

技术准备：SpringBoot 2.0 + MongoDB 4.2



### 二 设计思路

文件分类：

​	公共资源：public:/	任何人都共享

​	回收站：recycle:/		根据权限，每个人都会有一个回收站

​	我的文件：my:/		每个用户一个虚拟云盘



### 三 数据隔离

我的文件：每个人对应一个文件夹，仅此而已（它只不过是一串有规律的字符串）

匿名用户：anonymous

注册用户

炫耀：10T空间，花了钱VIP，他还不过是一个数字，权限校验而已。

网络云盘的存在解决的根本问题就是：解决资源共享的问题

校验每个文件是否相同两种方式：CRC32和MD5

规定：

​	根目录path /

​	子目录 /xx/xx/AA/BB/EE

​	子目录 /xx/xx/AA

​	删除文件：path 包含 /xx/xx/AA/

在创建文件夹时，同级目录不允许重名

这个文件是由谁上传的

MongoDB存文件风险大？把文件转储到本地

1c465fbc544370bc65a69458535336d3 它就是文件的唯一ID

磁盘的读写性能是没有内存的读写性能搞的

文件的单体传输非常大的

因为磁盘上目录里面的文件是有上限的

用户的注册量达到了

\1c4\65f\bc5\443\70b\c65\a69\458\535\336\d3

\1c4\65f\bc5\443\70b\c65\a69\458\535\336\d3\Test\One\Two\Three\Four



### 四 高效存储解决方案

磁盘存储，MongoDB存储
虚拟空间管理

多数据源操作



### 五 主要功能

上传、下载（FlashReader，swf，Word，PDF，Excel，MP4等）、预览、查询、无限极目录

FFMPEG /多媒体的互转   Word 转成 Swf、 MP4/WVM.... /MP4.H264



.json ajax交互的格式

.file 针对文件本身的操作，预览，下载



如果做动静分离之后，我会用Nginx来承担一些功能


通常，文件的存储有3种
1. 直接写磁盘，通过nginx来访问。    显然，性能下降
2. 分布式文件系统，比如FastDFS		推荐方案，性能是最高的，易扩容，扩容比较难定
3. MongoDB，你把它当做缓存，方便	不推荐（只是因为恰好我自己做过）







